import confetti from 'canvas-confetti'
import { div, dom, emit, on, pickOne, sleep, storage, tw } from 'shuutils'
import type { AirtableResponse, AirtableTask } from '../types'
import { button } from '../utils/dom'
import { logger } from '../utils/logger'
import { state, watchState } from '../utils/state'
import { isTaskActive, toggleComplete } from '../utils/tasks'
import { progress } from './progress'

const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', 'üôà', 'üôâ', 'üôä', 'üíã', 'üíå', 'üíò', 'üíù', 'üíñ', 'üíó', 'üíì', 'üíû', 'üíï', 'üíü', 'üíî', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'ü§ç', 'üíØ', 'üí¢', 'üí•', 'üí´', 'üí¶', 'üí®', 'üí£', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üí≠', 'üí§', 'üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§è', '‚úå', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òù', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úç', 'üíÖ', 'ü§≥', 'üí™', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÖ', 'üëÑ', 'üë∂', 'üßí', 'üë¶', 'üëß', 'üßë', 'üë±', 'üë®', 'üßî', 'üë®‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë®‚Äçü¶≥', 'üë®‚Äçü¶≤', 'üë©', 'üë©‚Äçü¶∞', 'üë©‚Äçü¶±', 'üë©‚Äçü¶≥', 'üë©‚Äçü¶≤', 'üë±‚Äç‚ôÄÔ∏è', 'üë±‚Äç‚ôÇÔ∏è', 'üßì', 'üë¥', 'üëµ', 'üôç', 'üôç‚Äç‚ôÇÔ∏è', 'üôç‚Äç‚ôÄÔ∏è', 'üôé', 'üôé‚Äç‚ôÇÔ∏è', 'üôé‚Äç‚ôÄÔ∏è', 'üôÖ', 'üôÖ‚Äç‚ôÇÔ∏è', 'üôÖ‚Äç‚ôÄÔ∏è', 'üôÜ', 'üôÜ‚Äç‚ôÇÔ∏è', 'üôÜ‚Äç‚ôÄÔ∏è', 'üíÅ', 'üíÅ‚Äç‚ôÇÔ∏è', 'üíÅ‚Äç‚ôÄÔ∏è', 'üôã', 'üôã‚Äç‚ôÇÔ∏è', 'üôã‚Äç‚ôÄÔ∏è', 'üßè', 'üßè‚Äç‚ôÇÔ∏è', 'üßè‚Äç‚ôÄÔ∏è', 'üôá', 'üôá‚Äç‚ôÇÔ∏è', 'üôá‚Äç‚ôÄÔ∏è', 'ü§¶', 'ü§¶‚Äç‚ôÇÔ∏è', 'ü§¶‚Äç‚ôÄÔ∏è', 'ü§∑', 'ü§∑‚Äç‚ôÇÔ∏è', 'ü§∑‚Äç‚ôÄÔ∏è', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'üë®‚Äçüè´', 'üë©‚Äçüè´', 'üë®‚Äç‚öñÔ∏è', 'üë©‚Äç‚öñÔ∏è', 'üë®‚Äçüåæ', 'üë©‚Äçüåæ', 'üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üë®‚Äçüîß', 'üë©‚Äçüîß', 'üë®‚Äçüè≠', 'üë©‚Äçüè≠', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüî¨', 'üë©‚Äçüî¨', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüé§', 'üë©‚Äçüé§', 'üë®‚Äçüé®', 'üë©‚Äçüé®', 'üë®‚Äç‚úàÔ∏è', 'üë©‚Äç‚úàÔ∏è', 'üë®‚ÄçüöÄ', 'üë©‚ÄçüöÄ', 'üë®‚Äçüöí', 'üë©‚Äçüöí', 'üëÆ', 'üëÆ‚Äç‚ôÇÔ∏è', 'üëÆ‚Äç‚ôÄÔ∏è', 'üïµ', 'üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üíÇ', 'üíÇ‚Äç‚ôÇÔ∏è', 'üíÇ‚Äç‚ôÄÔ∏è', 'üë∑', 'üë∑‚Äç‚ôÇÔ∏è', 'üë∑‚Äç‚ôÄÔ∏è', 'ü§¥', 'üë∏', 'üë≥', 'üë≥‚Äç‚ôÇÔ∏è', 'üë≥‚Äç‚ôÄÔ∏è', 'üë≤', 'üßï', 'ü§µ', 'üë∞', 'ü§∞', 'ü§±', 'üëº', 'üéÖ', 'ü§∂', 'ü¶∏', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶π', 'ü¶π‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è', 'üßô', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßö', 'üßö‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'üßõ', 'üßõ‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßú', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è', 'üßù', 'üßù‚Äç‚ôÇÔ∏è', 'üßù‚Äç‚ôÄÔ∏è', 'üßû', 'üßû‚Äç‚ôÇÔ∏è', 'üßû‚Äç‚ôÄÔ∏è', 'üßü', 'üßü‚Äç‚ôÇÔ∏è', 'üßü‚Äç‚ôÄÔ∏è', 'üíÜ', 'üíÜ‚Äç‚ôÇÔ∏è', 'üíÜ‚Äç‚ôÄÔ∏è', 'üíá', 'üíá‚Äç‚ôÇÔ∏è', 'üíá‚Äç‚ôÄÔ∏è', 'üö∂', 'üö∂‚Äç‚ôÇÔ∏è', 'üö∂‚Äç‚ôÄÔ∏è', 'üßç', 'üßç‚Äç‚ôÇÔ∏è', 'üßç‚Äç‚ôÄÔ∏è', 'üßé', 'üßé‚Äç‚ôÇÔ∏è', 'üßé‚Äç‚ôÄÔ∏è', 'üë®‚Äçü¶Ø', 'üë©‚Äçü¶Ø', 'üë®‚Äçü¶º', 'üë©‚Äçü¶º', 'üë®‚Äçü¶Ω', 'üë©‚Äçü¶Ω', 'üèÉ', 'üèÉ‚Äç‚ôÇÔ∏è', 'üèÉ‚Äç‚ôÄÔ∏è', 'üíÉ', 'üï∫', 'üï¥', 'üëØ', 'üëØ‚Äç‚ôÇÔ∏è', 'üëØ‚Äç‚ôÄÔ∏è', 'üßñ', 'üßñ‚Äç‚ôÇÔ∏è', 'üßñ‚Äç‚ôÄÔ∏è', 'üßó', 'üßó‚Äç‚ôÇÔ∏è', 'üßó‚Äç‚ôÄÔ∏è', 'ü§∫', 'üèá', '‚õ∑', 'üèÇ', 'üèå', 'üèåÔ∏è‚Äç‚ôÇÔ∏è', 'üèåÔ∏è‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèÑ‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üö£', 'üö£‚Äç‚ôÇÔ∏è', 'üö£‚Äç‚ôÄÔ∏è', 'üèä', 'üèä‚Äç‚ôÇÔ∏è', 'üèä‚Äç‚ôÄÔ∏è', '‚õπ', '‚õπÔ∏è‚Äç‚ôÇÔ∏è', '‚õπÔ∏è‚Äç‚ôÄÔ∏è', 'üèã', 'üèãÔ∏è‚Äç‚ôÇÔ∏è', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üö¥', 'üö¥‚Äç‚ôÇÔ∏è', 'üö¥‚Äç‚ôÄÔ∏è', 'üöµ', 'üöµ‚Äç‚ôÇÔ∏è', 'üöµ‚Äç‚ôÄÔ∏è', 'ü§∏', 'ü§∏‚Äç‚ôÇÔ∏è', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§º‚Äç‚ôÇÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§Ω', 'ü§Ω‚Äç‚ôÇÔ∏è', 'ü§Ω‚Äç‚ôÄÔ∏è', 'ü§æ', 'ü§æ‚Äç‚ôÇÔ∏è', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§π', 'ü§π‚Äç‚ôÇÔ∏è', 'ü§π‚Äç‚ôÄÔ∏è', 'üßò', 'üßò‚Äç‚ôÇÔ∏è', 'üßò‚Äç‚ôÄÔ∏è', 'üõÄ', 'üõå', 'üë£', 'ü¶∞', 'ü¶±', 'ü¶≥', 'ü¶≤', 'üêµ', 'üêí', 'ü¶ç', 'ü¶ß', 'üê∂', 'üêï', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üê©', 'üê∫', 'ü¶ä', 'ü¶ù', 'üê±', 'üêà', 'ü¶Å', 'üêØ', 'üêÖ', 'üêÜ', 'üê¥', 'üêé', 'ü¶Ñ', 'ü¶ì', 'ü¶å', 'üêÆ', 'üêÇ', 'üêÉ', 'üêÑ', 'üê∑', 'üêñ', 'üêó', 'üêΩ', 'üêè', 'üêë', 'üêê', 'üê™', 'üê´', 'ü¶ô', 'ü¶í', 'üêò', 'ü¶è', 'ü¶õ', 'üê≠', 'üêÅ', 'üêÄ', 'üêπ', 'üê∞', 'üêá', 'ü¶î', 'ü¶á', 'üêª', 'üê®', 'üêº', 'ü¶•', 'ü¶¶', 'ü¶®', 'ü¶ò', 'ü¶°', 'üêæ', 'ü¶É', 'üêî', 'üêì', 'üê£', 'üê§', 'üê•', 'üê¶', 'üêß', 'ü¶Ö', 'ü¶Ü', 'ü¶¢', 'ü¶â', 'ü¶©', 'ü¶ö', 'ü¶ú', 'üê∏', 'üêä', 'üê¢', 'ü¶é', 'üêç', 'üê≤', 'üêâ', 'ü¶ï', 'ü¶ñ', 'üê≥', 'üêã', 'üê¨', 'üêü', 'üê†', 'üê°', 'ü¶à', 'üêô', 'üêö', 'üêå', 'ü¶ã', 'üêõ', 'üêú', 'üêù', 'üêû', 'ü¶ó', 'ü¶Ç', 'ü¶ü', 'ü¶†', 'üíê', 'üå∏', 'üíÆ', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üå±', 'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üåæ', 'üåø', '‚òò', 'üçÄ', 'üçÅ', 'üçÇ', 'üçÉ', 'üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü•ù', 'üçÖ', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üçÑ', 'ü•ú', 'üå∞', 'üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•û', 'üßá', 'üßÄ', 'üçñ', 'üçó', 'ü•©', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'ü•ö', 'üç≥', 'ü•ò', 'üç≤', 'ü•£', 'ü•ó', 'üçø', 'üßà', 'üßÇ', 'ü•´', 'üç±', 'üçò', 'üçô', 'üçö', 'üçõ', 'üçú', 'üçù', 'üç†', 'üç¢', 'üç£', 'üç§', 'üç•', 'ü•Æ', 'üç°', 'ü•ü', 'ü•†', 'ü•°', 'ü¶Ä', 'ü¶û', 'ü¶ê', 'ü¶ë', 'ü¶™', 'üç¶', 'üçß', 'üç®', 'üç©', 'üç™', 'üéÇ', 'üç∞', 'üßÅ', 'ü•ß', 'üç´', 'üç¨', 'üç≠', 'üçÆ', 'üçØ', 'üçº', 'ü•õ', '‚òï', 'üçµ', 'üç∂', 'üçæ', 'üç∑', 'üç∏', 'üçπ', 'üç∫', 'üçª', 'ü•Ç', 'ü•É', 'ü•§', 'üßÉ', 'üßâ', 'üßä', 'ü•¢', 'üçΩ', 'üç¥', 'ü•Ñ', 'üî™', 'üè∫', 'üåç', 'üåé', 'üåè', 'üåê', 'üóæ', 'üß≠', 'üèî', '‚õ∞', 'üåã', 'üóª', 'üß±', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè©', 'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üíí', 'üóº', 'üóΩ', '‚õ™', 'üïå', 'üõï', 'üïç', '‚õ©', 'üïã', '‚õ≤', '‚õ∫', 'üåÅ', 'üåÉ', 'üåÑ', 'üåÖ', 'üåÜ', 'üåá', 'üåâ', 'üé†', 'üé°', 'üé¢', 'üíà', 'üé™', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ', 'üöú', 'üõµ', 'ü¶Ω', 'ü¶º', 'üõ∫', 'üö≤', 'üõ¥', 'üõπ', 'üöè', '‚õΩ', 'üö®', 'üö•', 'üö¶', 'üõë', 'üöß', '‚öì', '‚õµ', 'üõ∂', 'üö§', 'üö¢', 'üõ´', 'üõ¨', 'ü™Ç', 'üí∫', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞', 'üöÄ', 'üõ∏', 'üß≥', '‚åõ', '‚è≥', '‚åö', '‚è∞', '‚è±', '‚è≤', 'üï∞', 'üïõ', 'üïß', 'üïê', 'üïú', 'üïë', 'üïù', 'üïí', 'üïû', 'üïì', 'üïü', 'üïî', 'üï†', 'üïï', 'üï°', 'üïñ', 'üï¢', 'üïó', 'üï£', 'üïò', 'üï§', 'üïô', 'üï•', 'üïö', 'üï¶', 'üåë', 'üåí', 'üåì', 'üåî', 'üåï', 'üåñ', 'üåó', 'üåò', 'üåô', 'üåö', 'üåõ', 'üåú', 'üåù', 'üåû', 'ü™ê', '‚≠ê', 'üåü', 'üå†', 'üåå', '‚õÖ', 'üåÄ', 'üåà', 'üåÇ', '‚òî', '‚ö°', '‚õÑ', 'üî•', 'üíß', 'üåä', 'üéÉ', 'üéÑ', 'üéÜ', 'üéá', 'üß®', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üéã', 'üéç', 'üéé', 'üéè', 'üéê', 'üéë', 'üßß', 'üéÄ', 'üéÅ', 'üéó', 'üéü', 'üé´', 'üèÜ', 'üèÖ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', '‚öæ', 'ü•é', 'üèÄ', 'üèê', 'üèà', 'üèâ', 'üéæ', 'ü•è', 'üé≥', 'üèè', 'üèë', 'üèí', 'ü•ç', 'üèì', 'üè∏', 'ü•ä', 'ü•ã', 'ü•Ö', '‚õ≥', '‚õ∏', 'üé£', 'ü§ø', 'üéΩ', 'üéø', 'üõ∑', 'ü•å', 'üéØ', 'ü™Ä', 'ü™Å', 'üé±', 'üîÆ', 'üßø', 'üéÆ', 'üé∞', 'üé≤', 'üß©', 'üß∏', 'üÉè', 'üÄÑ', 'üé¥', 'üé≠', 'üé®', 'üßµ', 'üß∂', 'üëì', 'ü•Ω', 'ü•º', 'ü¶∫', 'üëî', 'üëï', 'üëñ', 'üß£', 'üß§', 'üß•', 'üß¶', 'üëó', 'üëò', 'ü•ª', 'ü©±', 'ü©≤', 'ü©≥', 'üëô', 'üëö', 'üëõ', 'üëú', 'üëù', 'üéí', 'üëû', 'üëü', 'ü•æ', 'ü•ø', 'üë†', 'üë°', 'ü©∞', 'üë¢', 'üëë', 'üëí', 'üé©', 'üéì', 'üß¢', 'üìø', 'üíÑ', 'üíç', 'üíé', 'üîá', 'üîà', 'üîâ', 'üîä', 'üì¢', 'üì£', 'üìØ', 'üîî', 'üîï', 'üéº', 'üéµ', 'üé∂', 'üé§', 'üéß', 'üìª', 'üé∑', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'ü™ï', 'ü•Å', 'üì±', 'üì≤', 'üìû', 'üìü', 'üì†', 'üîã', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üé•', 'üé¨', 'üì∫', 'üì∑', 'üì∏', 'üìπ', 'üìº', 'üîç', 'üîé', 'üí°', 'üî¶', 'üèÆ', 'ü™î', 'üìî', 'üìï', 'üìñ', 'üìó', 'üìò', 'üìô', 'üìö', 'üìì', 'üìí', 'üìÉ', 'üìú', 'üìÑ', 'üì∞', 'üóû', 'üìë', 'üîñ', 'üí∞', 'üí¥', 'üíµ', 'üí∂', 'üí∑', 'üí∏', 'üí≥', 'üßæ', 'üìß', 'üì®', 'üì©', 'üì§', 'üì•', 'üì¶', 'üì´', 'üì™', 'üì¨', 'üì≠', 'üìÆ', 'üìù', 'üìÅ', 'üìÇ', 'üóÇ', 'üìÖ', 'üìÜ', 'üìá', 'üìà', 'üìâ', 'üìä', 'üìã', 'üìå', 'üìç', 'üìè', 'üìê', 'üîí', 'üîì', 'üîè', 'üîê', 'üîë', 'üî®', 'ü™ì', 'üî´', 'üèπ', 'üîß', 'üî©', 'ü¶Ø', 'üîó', 'üß∞', 'üß≤', 'üß™', 'üß´', 'üß¨', 'üî¨', 'üî≠', 'üì°', 'üíâ', 'ü©∏', 'üíä', 'ü©π', 'ü©∫', 'ü™ë', 'üöΩ', 'üöø', 'üõÅ', 'ü™í', 'üß¥', 'üß∑', 'üßπ', 'üß∫', 'üßª', 'üßº', 'üßΩ', 'üßØ', 'üõí', 'üö¨', 'üóø', 'üèß', 'üöÆ', 'üö∞', '‚ôø', 'üöπ', 'üö∫', 'üöª', 'üöº', 'üöæ', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üö∏', '‚õî', 'üö´', 'üö≥', 'üö≠', 'üöØ', 'üö±', 'üö∑', 'üìµ', 'üîû', 'üîÉ', 'üîÑ', 'üîô', 'üîö', 'üîõ', 'üîú', 'üîù', 'üõê', 'üïé', 'üîØ', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', '‚õé', 'üîÄ', 'üîÅ', 'üîÇ', '‚ñ∂', '‚è©', '‚è≠', '‚èØ', '‚óÄ', '‚è™', '‚èÆ', 'üîº', '‚è´', 'üîΩ', '‚è¨', '‚è∏', '‚èπ', '‚è∫', '‚èè', 'üé¶', 'üì∂', 'üì≥', 'üì¥', 'üí±', 'üí≤', 'üî±', 'üìõ', 'üî∞', '‚≠ï', '‚ùå', '‚û∞', '‚ûø', '#Ô∏è‚É£', '*Ô∏è‚É£', 'üîü', 'üî†', 'üî°', 'üî¢', 'üî£', 'üî§', 'üÖ∞', 'üÜé', 'üÖ±', 'üÜë', 'üÜí', 'üÜì', 'üÜî', 'üÜï', 'üÜñ', 'üÖæ', 'üÜó', 'üÖø', 'üÜò', 'üÜô', 'üÜö', 'üàÅ', 'üà∂', 'üâê', 'üàπ', 'üàö', 'üà≤', 'üâë', 'üà∏', 'üà¥', 'üà≥', 'üà∫', 'üàµ', 'üî¥', 'üü†', 'üü°', 'üîµ', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß', 'üü®', 'üü¶', 'üü™', 'üü´', '‚¨õ', '‚¨ú', 'üî∂', 'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí†', 'üîò', 'üî≥', 'üî≤', 'üèÅ', 'üö©', 'üéå', 'üè¥', 'üè≥Ô∏è‚Äçüåà', 'üè¥‚Äç‚ò†Ô∏è', 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø']

const tasks = div(tw('app-tasks grid gap-2'))
const lines: HTMLButtonElement[] = []

const fireworksLeft = new Audio('/fireworks.mp3')
const fireworksRight = new Audio('/fireworks.mp3')
tasks.append(progress)

const retry = button('Setup credentials', tw('mt-4 hidden'))
retry.addEventListener('click', () => {
  storage.clear('api-base')
  storage.clear('api-key')
  emit('need-credentials')
  retry.classList.toggle('hidden')
})
tasks.append(retry)

function handleError (response: AirtableResponse) {
  logger.error('handle error response', response)
  let message = response.error && response.error.type === 'UNAUTHORIZED' ? 'The credentials you provided does not work' : 'Failed to fetch data from Airtable'
  message += ', click the button below to try again.'
  state.statusError = message
  retry.classList.toggle('hidden')
}

on('get-tasks-error', handleError)

function updateLine (line: HTMLElement, task: AirtableTask) {
  const isActive = isTaskActive(task)
  const isDatasetActive = line.dataset.active === 'true'
  logger.debug('update line', line, 'was', isDatasetActive ? 'active' : 'inactive', 'now', isActive ? 'active' : 'inactive')
  line.dataset.active = String(isActive)
  line.innerHTML = `${isActive ? pickOne(emojis) : '‚úîÔ∏è'}&nbsp; ${task.fields.name}`
  line.classList.toggle('opacity-60', !isActive)
}

function createLine (task: AirtableTask) {
  const line = dom('button', tw('app-task -ml-2 mr-auto max-w-full overflow-hidden text-ellipsis whitespace-nowrap px-2 py-1 text-start transition-transform duration-300 ease-out'), task.fields.name)
  line.dataset.taskId = task.id
  updateLine(line, task)
  lines.push(line)
  return line
}

// eslint-disable-next-line max-params
async function throwConfetti (x: number, y: number, angle: number, sound: HTMLAudioElement) { // eslint-disable-line id-length
  void sound.play()
  void confetti({ angle, origin: { x, y } }) // eslint-disable-line id-length
  await sleep(200) // eslint-disable-line @typescript-eslint/no-magic-numbers
}

async function throwConfettiAround (element: HTMLElement) {
  /* eslint-disable @typescript-eslint/no-magic-numbers */
  const { bottom, left, right } = element.getBoundingClientRect()
  const delta = window.innerWidth < 450 ? 90 : 30
  const positionY = Math.round(bottom / window.innerHeight * 100) / 100
  let positionX = Math.round((left + delta) / window.innerWidth * 100) / 100
  const angle = 20
  await throwConfetti(positionX, positionY, 90 + angle, fireworksLeft)
  positionX = Math.round((right - delta) / window.innerWidth * 100) / 100
  await throwConfetti(positionX, positionY, 90 - angle, fireworksRight)
  /* eslint-enable @typescript-eslint/no-magic-numbers */
}

async function visuallyToggleComplete (line: HTMLElement, task: AirtableTask) {
  line.classList.add('scale-125')
  const hasBeenUpdated = await toggleComplete(task)
  line.classList.remove('scale-125')
  return hasBeenUpdated
}

function getTaskFromElement (element: HTMLElement | null, list: AirtableTask[]) {
  const task = list.find(t => t.id === element?.dataset.taskId)
  if (task === undefined) logger.error('failed to find task with id', element?.dataset.taskId, 'in list', list)
  return task
}

async function onClick (line: HTMLElement | null, list: AirtableTask[]) {
  const task = getTaskFromElement(line, list)
  if (task === undefined || line === null) return
  const hasBeenUpdated = await visuallyToggleComplete(line, task)
  if (!hasBeenUpdated) { logger.error('failed to update this task'); return }
  if (!isTaskActive(task)) void throwConfettiAround(line)
  state.tasks = state.tasks.map(t => (t.id === task.id ? task : t))
  updateLine(line, task)
}

function updateList (list: AirtableTask[]) {
  if (list.length === 0) { logger.info('no task list to display'); return }
  logger.info('update list...')
  const processed: string[] = []
  lines.forEach(line => {
    const task = list.find(t => (t.id === line.dataset.taskId))
    if (task === undefined) line.classList.add('hidden') // hide the task in dom that is not active anymore
    else {
      processed.push(task.id)
      updateLine(line, task)
    }
  })
  const missing = list.filter(t => !processed.includes(t.id)) // exists on Airtable but not in dom
  if (missing.length > 0) logger.info('missing tasks', missing)
  missing.forEach(task => { tasks.append(createLine(task)) })
}

watchState('tasks', () => { updateList(state.tasks) })

watchState('isSetup', () => { if (state.isSetup && state.tasks.length > 0) updateList(state.tasks) })

// eslint-disable-next-line @typescript-eslint/consistent-type-assertions
tasks.addEventListener('click', (event: Event) => { void onClick(event.target as HTMLElement, state.tasks) })

export { tasks }

