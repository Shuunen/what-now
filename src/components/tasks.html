<main class="tasks col center">
  <h1 class="tasks--title task--get" onclick="tasks.showTask()">What <em>now</em> ?</h1>
  <div class="task col hidden">
    <h2 class="task--title"></h2>
    <div>
      <button class="task--mark-as-done" onclick="tasks.doneTask()">Done</button>
    </div>
  </div>
</main>

<script>
  class Task {
    constructor (data) {
      Object.assign(this, data)
      if (!this.active) {
        this.emit('task-done', { already: true })
      }
    }

    async emit (eventName, eventData) {
      console.log(eventName, eventData)
      window.dispatchEvent(new CustomEvent(eventName, { detail: eventData }))
    }

    get completedOn () {
      return this['completed-on']
    }

    get active () {
      if (this.done) {
        return false
      }
      if (!this.completedOn) {
        return true
      }
      switch (this.once) {
        case 'yes':
          return true
        case 'day':
          return this.daysSinceCompletion >= 1
        case 'week':
          return this.daysSinceCompletion >= 7
        case 'month':
          return this.daysSinceCompletion >= 30
        default:
          console.error('unhandled case')
      }
      return false
    }

    get daysSinceCompletion () {
      return ((new Date(this.today()) - new Date(this.completedOn)) / 1000 / (3600 * 24))
    }

    today () {
      // give the same format as 'completed-on' like "2019-07-14"
      return new Date().toISOString().split('T')[0]
    }

    complete () {
      this['completed-on'] = this.today()
      // task is complete for today, but can be done totally is it was a one time job
      this.done = (this.once === 'yes')
      this.emit('task-update', Object.assign({}, this))
      this.emit('task-done', { already: false })
    }
  }

  class Tasks {
    get taskViewDisplayed () {
      return !this.taskEl.classList.contains('hidden')
    }

    get activeTask () {
      return this.tasks[this.index]
    }

    constructor () {
      this.setupElements()
      this.setupListeners()
    }

    async emit (eventName, eventData) {
      console.log(eventName, eventData)
      window.dispatchEvent(new CustomEvent(eventName, { detail: eventData }))
    }

    async sleep (ms) {
      return new Promise(resolve => setTimeout(resolve, (ms || 1000)))
    }

    setupElements () {
      this.tasksTitle = document.querySelector('.tasks--title')
      this.taskEl = document.querySelector('.tasks .task')
      this.taskTitle = this.taskEl.querySelector('.task--title')
      this.doneButtonEl = this.taskEl.querySelector('.task--mark-as-done')
    }

    setupListeners () {
      window.addEventListener('tasks-loaded', event => this.onTasksLoaded(event.detail))
      window.addEventListener('skip-task', event => this.onSkipTask())
      window.addEventListener('keyup', (event) => {
        if (event.code === 'Space' || event.code === 'Enter') {
          if (this.taskViewDisplayed) return this.doneTask()
          return this.showTask()
        }
        if (event.code === 'ArrowLeft' || event.code === 'ArrowUp') return this.onSkipTask(true)
        if (event.code === 'ArrowRight' || event.code === 'ArrowDown') return this.onSkipTask()
      })
    }

    onTasksLoaded (tasks) {
      this.index = 0
      this.tasks = tasks.map(data => new Task(data))
      this.showToast(this.tasks.length ? 'info' : 'error', (this.tasks.length || 'no') + ' tasks found')
      this.showMainView()
      this.checkTasks()
      this.emit('action-required', false)
    }

    onSkipTask (reverse = false) {
      if (!this.taskViewDisplayed || !this.activeTask) {
        return console.log('cannot skip task if none displayed')
      }
      if (this.tasks.length === 1) {
        return console.log('cannot skip the only task')
      }
      this.setupNextTask(reverse)
      this.emit('task-skipped')
    }

    checkTasks () {
      const hadActiveTasks = this.tasks.length > 0
      this.tasks = this.tasks.filter(task => task.active)
      const hasActiveTasks = this.tasks.length > 0
      if (hasActiveTasks && this.activeTask === undefined) {
        this.index = 0
      }
      if (hadActiveTasks && !hasActiveTasks) {
        this.showSuccessView()
      }
    }

    showToast (type, message) {
      return this.emit('show-toast', { type, message })
    }

    showTask () {
      if (!this.activeTask) {
        return
      }
      this.switchView()
    }

    switchView (el) {
      this.taskTitle.textContent = this.activeTask.name
      this.taskEl.classList.toggle('hidden')
      this.tasksTitle.classList.toggle('hidden')
    }

    async doneTask () {
      this.doneButtonEl.classList.toggle('hide')
      this.taskTitle.style.animationName = 'bounceOutRight'
      this.showToast('success', 'well done')
      this.activeTask.complete()
      await this.sleep(1000)
      this.switchView()
      this.doneButtonEl.classList.toggle('hide')
      this.taskTitle.style.animationName = ''
      this.checkTasks()
    }

    setupNextTask (reverse) {
      this.index += reverse ? -1 : 1
      this.index = this.activeTask ? this.index : (reverse ? this.tasks.length - 1 : 0)
      this.taskTitle.textContent = this.activeTask.name
    }

    showMainView () {
      this.tasksTitle.innerHTML = 'What <em>now</em> ?'
      this.tasksTitle.classList.remove('success')
      if (this.taskViewDisplayed) {
        this.switchView()
      }
    }

    showSuccessView () {
      this.tasksTitle.innerHTML = '<p>You did everything for today üéñÔ∏è</p>'
      this.tasksTitle.classList.add('success')
      this.showToast('info', 'üéâüçæü•Çüéâ')
      this.emit('tasks-done', {})
    }
  }
  // eslint-disable-next-line no-new
  window.tasks = new Tasks()
</script>

<style>
  .tasks {
    color: var(--color-primary, steelblue);
    position: absolute;
    top: calc(50% - 5rem);
    height: 10rem;
    width: 100%;
    align-items: center;
    justify-content: center;
    z-index: var(--elevation-child, 30);
  }

  .tasks--title,
  .task--title {
    box-shadow: 0 0 2rem -.8rem var(--color-black, #333333);
  }

  .tasks--title {
    color: var(--color-black, #333333);
    font-size: 3rem;
  }

  .task--title {
    font-size: 2rem;
    margin-bottom: 1rem;
    animation-duration: 1s;
    animation-fill-mode: both;
  }

  .tasks--title p {
    margin: 1rem 0;
  }

  .tasks--title.success {
    color: var(--color-success, green);
    margin-top: -4rem;
  }

  .tasks--title em {
    color: var(--color-primary, steelblue);
    font-style: normal;
  }

  @keyframes bounceOutRight {
    20% {
      opacity: 1;
      transform: translate3d(-20px, 0, 0);
    }

    to {
      opacity: 0;
      transform: translate3d(2000px, 0, 0);
    }
  }
</style>
