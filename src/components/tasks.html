<main class="tasks col center">
  <h1 class="tasks--title task--get" onclick="tasks.getTask()">What <em>now</em> ?</h1>
  <div class="task col hidden">
    <h2 class="task--title"></h2>
    <div>
      <button class="task--mark-as-done" onclick="tasks.doneTask()">Done</button>
    </div>
  </div>
</main>

<script>
  class Tasks {
    constructor () {
      this.tasksTitle = document.querySelector('.tasks--title')
      this.taskEl = document.querySelector('.tasks .task')
      this.taskTitle = this.taskEl.querySelector('.task--title')
      this.tasks = []
      this.activeTask = null
      this.setupListeners()
    }
    setupListeners () {
      window.addEventListener('tasks-loaded', (event) => {
        this.tasks = event.detail
        this.showToast(this.tasks.length ? 'info' : 'error', (this.tasks.length || 'no') + ' tasks found')
        this.showMainView()
        this.checkTasks()
        this.emit('action-required', false)
      })
    }
    async emit (eventName, eventData) {
      console.log(`%c${eventName}`, 'color: blue', eventData)
      window.dispatchEvent(new CustomEvent(eventName, { detail: eventData }))
    }
    checkTasks () {
      const hadActiveTasks = this.tasks.length > 0
      const today = this.getDate()
      // TODO: prendre en charge les autres situations qu'une tache quotidienne
      this.tasks = this.tasks.filter(t => (t['completed-on'] !== today))
      const hasActiveTasks = this.tasks.length > 0
      if (hadActiveTasks && !hasActiveTasks) {
        this.showSuccessView()
      }
    }
    showToast (type, message) {
      return this.emit('show-toast', { type, message })
    }
    getTask () {
      this.activeTask = this.tasks.find(t => !t.done)
      this.switchView()
    }
    switchView (el) {
      this.taskTitle.textContent = this.activeTask.name
      this.taskEl.classList.toggle('hidden')
      this.tasksTitle.classList.toggle('hidden')
    }
    doneTask () {
      this.showToast('success', 'well done')
      this.activeTask['completed-on'] = this.getDate()
      this.emit('task-update', Object.assign({}, this.activeTask))
      this.switchView()
      this.checkTasks()
    }
    getDate () {
      return new Date().toISOString().split('T')[0]
    }
    showMainView () {
      this.tasksTitle.innerHTML = 'What <em>now</em> ?'
      this.tasksTitle.classList.remove('success')
      if (this.tasksTitle.classList.contains('hidden')) {
        this.switchView()
      }
    }
    showSuccessView () {
      this.tasksTitle.innerHTML = 'You did everything for today.<br><em>GG</em> üéñÔ∏è'
      this.tasksTitle.classList.add('success')
      this.showToast('info', 'üéâüçæü•Çüéâ')
    }
  }
  // eslint-disable-next-line no-new
  window.tasks = new Tasks()
</script>

<style>
  .tasks {
    background-image: linear-gradient(var(--color-white, whitesmoke) 60%, var(--color-grey, grey) 170%);
    color: var(--color-primary, steelblue);
    height: 100%;
    justify-content: center;
    padding-bottom: 2rem;
    width: 100%;
  }

  .tasks--title {
    border-bottom: .2rem dashed;
    padding: 1rem;
  }

  .tasks--title.success {
    border-style: dashed;
    border-width: .4rem 0;
    color: var(--color-success, green);
  }

  .tasks--title em {
    color: var(--color-black, #333333);
    font-style: normal;
  }
</style>
